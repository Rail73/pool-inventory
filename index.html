<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pool Parts Inventory System</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="max-w-6xl mx-auto p-4">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">üèä‚Äç‚ôÇÔ∏è Pool Parts Inventory</h1>
                    <p class="text-gray-600">Professional inventory management system</p>
                </div>
                <div class="flex gap-2">
                    <button id="setupBtn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                        ‚öôÔ∏è Setup
                    </button>
                    <button id="kitsBtn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700" disabled>
                        üì¶ Kits
                    </button>
                    <button id="refreshBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700" disabled>
                        üîÑ Refresh
                    </button>
                    <button id="addBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700" disabled>
                        ‚ûï Add Part
                    </button>
                </div>
            </div>

            <!-- Status -->
            <div class="mt-4">
                <div id="connectionStatus" class="p-4 rounded-lg bg-red-50 border border-red-200">
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-red-500"></span>
                        <span class="font-medium text-red-800">Not Connected</span>
                    </div>
                    <p class="text-red-600 text-sm mt-1">Click Setup to configure Google Sheets connection</p>
                </div>
            </div>
        </div>

        <!-- Setup Panel -->
        <div id="setupPanel" class="bg-blue-50 p-6 rounded-lg mb-6 border border-blue-200">
            <h2 class="text-xl font-semibold mb-4">üöÄ Setup Google Sheets Integration</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-semibold mb-2">Step 1: Create Google Sheets</h3>
                    <p class="text-sm text-gray-600 mb-2">Headers in row 1:</p>
                    <div class="bg-gray-100 p-2 rounded font-mono text-sm">
                        id | name | currentStock | minStock | price | supplier
                    </div>
                    <p class="text-sm text-gray-600 mt-2">Sample data in row 2:</p>
                    <div class="bg-gray-100 p-2 rounded font-mono text-sm">
                        1 | Sand Filter 24" | 3 | 2 | 450 | AquaTech
                    </div>
                </div>

                <div>
                    <h3 class="font-semibold mb-2">Step 2: Apps Script Setup</h3>
                    <ol class="text-sm list-decimal list-inside space-y-1">
                        <li>Extensions ‚Üí Apps Script</li>
                        <li>Replace code with script below</li>
                        <li>Deploy ‚Üí New deployment</li>
                        <li>Type: Web application</li>
                        <li>Access: Anyone</li>
                        <li>Copy URL and paste below</li>
                    </ol>
                </div>
            </div>

            <div class="mt-4">
                <label class="block text-sm font-medium mb-1">Google Apps Script URL:</label>
                <div class="flex gap-2">
                    <input 
                        type="text" 
                        id="apiUrl" 
                        placeholder="https://script.google.com/macros/s/YOUR_ID/exec"
                        class="flex-1 px-3 py-2 border rounded-lg"
                    >
                    <button id="connectBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        Connect
                    </button>
                </div>
            </div>

            <details class="mt-4">
                <summary class="cursor-pointer font-semibold">üìÑ Apps Script Code</summary>
                <div class="mt-2">
                    <button id="copyCodeBtn" class="bg-green-500 text-white px-3 py-1 rounded text-sm mb-2">
                        üìã Copy Code
                    </button>
                    <pre id="codeBlock" class="bg-gray-900 text-green-400 p-4 rounded text-sm overflow-x-auto max-h-64"><code>function doGet(e) {
  if (!e || !e.parameter) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false, error: 'No parameters'
    })).setMimeType(ContentService.MimeType.JSON);
  }
  
  const action = e.parameter.action;
  let result;
  
  switch(action) {
    case 'getParts':
      result = getParts();
      break;
    case 'test':
      result = { success: true, message: 'Connection works!' };
      break;
    default:
      result = { success: false, error: 'Unknown action' };
  }
  
  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    let result;
    
    switch(data.action) {
      case 'addPart':
        result = addPart(data);
        break;
      case 'updateStock':
        result = updateStock(data);
        break;
      case 'deletePart':
        result = deletePart(data);
        break;
      default:
        result = { success: false, error: 'Unknown action' };
    }
    
    return ContentService.createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false, error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function getParts() {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) return { success: true, data: [] };
    
    const parts = [];
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if (row[0] && row[1]) {
        parts.push({
          id: row[0],
          name: row[1],
          currentStock: parseInt(row[2]) || 0,
          minStock: parseInt(row[3]) || 0,
          price: parseFloat(row[4]) || 0,
          supplier: row[5] || ''
        });
      }
    }
    
    return { success: true, data: parts };
  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

function addPart(data) {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const lastRow = sheet.getLastRow();
    
    sheet.appendRow([
      lastRow,
      data.name,
      parseInt(data.currentStock) || 0,
      parseInt(data.minStock) || 0,
      parseFloat(data.price) || 0,
      data.supplier || ''
    ]);
    
    return { success: true, message: 'Part added' };
  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

function updateStock(data) {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const values = sheet.getDataRange().getValues();
    
    for (let i = 1; i < values.length; i++) {
      if (values[i][0] == data.id) {
        const newStock = Math.max(0, parseInt(values[i][2]) + parseInt(data.change));
        sheet.getRange(i + 1, 3).setValue(newStock);
        return { success: true, message: 'Stock updated' };
      }
    }
    
    return { success: false, error: 'Part not found' };
  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

function deletePart(data) {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const values = sheet.getDataRange().getValues();
    
    for (let i = 1; i < values.length; i++) {
      if (values[i][0] == data.id) {
        sheet.deleteRow(i + 1);
        return { success: true, message: 'Part deleted' };
      }
    }
    
    return { success: false, error: 'Part not found' };
  } catch (error) {
    return { success: false, error: error.toString() };
  }
}</code></pre>
                </div>
            </details>
        </div>

        <!-- Stats -->
        <div id="statsPanel" class="hidden grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-50 p-4 rounded-lg">
                <div id="totalCount" class="text-2xl font-bold text-blue-600">0</div>
                <div class="text-sm text-gray-600">Total Parts</div>
            </div>
            <div class="bg-red-50 p-4 rounded-lg">
                <div id="criticalCount" class="text-2xl font-bold text-red-600">0</div>
                <div class="text-sm text-gray-600">Critical Stock</div>
            </div>
            <div class="bg-green-50 p-4 rounded-lg">
                <div id="totalValue" class="text-2xl font-bold text-green-600">$0</div>
                <div class="text-sm text-gray-600">Total Value</div>
            </div>
            <div class="bg-purple-50 p-4 rounded-lg">
                <div id="kitsCount" class="text-2xl font-bold text-purple-600">0</div>
                <div class="text-sm text-gray-600">Kits Available</div>
            </div>
        </div>

        <!-- Search -->
        <div id="searchPanel" class="hidden mb-6">
            <input 
                type="text" 
                id="searchInput"
                placeholder="üîç Search parts..." 
                class="w-full px-4 py-2 border rounded-lg"
            >
        </div>

        <!-- Add Form -->
        <div id="addForm" class="hidden bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">Add New Part</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="partName" placeholder="Part Name" class="px-3 py-2 border rounded-lg">
                <input type="number" id="partStock" placeholder="Current Stock" class="px-3 py-2 border rounded-lg">
                <input type="number" id="partMinStock" placeholder="Min Stock" class="px-3 py-2 border rounded-lg">
                <input type="number" id="partPrice" placeholder="Price" class="px-3 py-2 border rounded-lg">
                <input type="text" id="partSupplier" placeholder="Supplier" class="px-3 py-2 border rounded-lg">
            </div>
            <div class="flex gap-2 mt-4">
                <button id="savePartBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Save</button>
                <button id="cancelAddBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">Cancel</button>
            </div>
        </div>

        <!-- Kits Panel -->
        <div id="kitsPanel" class="hidden bg-white p-6 rounded-lg shadow mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Parts Kits</h2>
                <div class="flex gap-2">
                    <button id="createKitBtn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Create Kit</button>
                    <button id="closeKitsBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">Close</button>
                </div>
            </div>
            <div id="kitsList"></div>
        </div>

        <!-- Parts Table -->
        <div id="tablePanel" class="hidden bg-white rounded-lg shadow overflow-hidden">
            <div class="p-4 border-b">
                <h2 class="text-xl font-semibold">Parts Inventory</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left">Name</th>
                            <th class="px-4 py-3 text-center">Stock</th>
                            <th class="px-4 py-3 text-center">Min</th>
                            <th class="px-4 py-3 text-center">Status</th>
                            <th class="px-4 py-3 text-right">Price</th>
                            <th class="px-4 py-3 text-left">Supplier</th>
                            <th class="px-4 py-3 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="partsTable"></tbody>
                </table>
            </div>
            <div id="noResults" class="text-center py-8 text-gray-500 hidden">No parts found</div>
        </div>
    </div>

    <script>
        // Global state
        let parts = [];
        let allParts = [];
        let kits = [];
        let apiUrl = '';
        let isConnected = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            setupEventListeners();
            loadSavedSettings();
        });

        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Button events
            document.getElementById('setupBtn').addEventListener('click', showSetup);
            document.getElementById('connectBtn').addEventListener('click', testConnection);
            document.getElementById('copyCodeBtn').addEventListener('click', copyCode);
            document.getElementById('refreshBtn').addEventListener('click', loadParts);
            document.getElementById('addBtn').addEventListener('click', showAddForm);
            document.getElementById('kitsBtn').addEventListener('click', showKitsPanel);
            document.getElementById('savePartBtn').addEventListener('click', addPart);
            document.getElementById('cancelAddBtn').addEventListener('click', hideAddForm);
            document.getElementById('createKitBtn').addEventListener('click', createKit);
            document.getElementById('closeKitsBtn').addEventListener('click', hideKitsPanel);
            
            // Search
            document.getElementById('searchInput').addEventListener('input', filterParts);
            
            console.log('Event listeners set up successfully');
        }

        function loadSavedSettings() {
            const savedUrl = localStorage.getItem('googleApiUrl');
            if (savedUrl) {
                document.getElementById('apiUrl').value = savedUrl;
                apiUrl = savedUrl;
                console.log('Loaded saved URL:', apiUrl);
            }
        }

        function showSetup() {
            const panel = document.getElementById('setupPanel');
            panel.classList.toggle('hidden');
        }

        async function testConnection() {
            const url = document.getElementById('apiUrl').value.trim();
            if (!url) {
                alert('Please enter a URL');
                return;
            }

            apiUrl = url;
            localStorage.setItem('googleApiUrl', url);

            try {
                console.log('Testing connection to:', url);
                const response = await fetch(url + '?action=test');
                const data = await response.json();
                
                if (data.success) {
                    setConnected(true);
                    await loadParts();
                    alert('‚úÖ Connected successfully!');
                } else {
                    throw new Error(data.error || 'Connection failed');
                }
            } catch (error) {
                console.error('Connection failed:', error);
                alert('‚ùå Connection failed: ' + error.message);
                setConnected(false);
            }
        }

        function setConnected(connected) {
            isConnected = connected;
            const status = document.getElementById('connectionStatus');
            
            if (connected) {
                status.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-green-500"></span>
                        <span class="font-medium text-green-800">Connected to Google Sheets</span>
                    </div>
                    <p class="text-green-600 text-sm mt-1">System ready!</p>
                `;
                status.className = 'p-4 rounded-lg bg-green-50 border border-green-200';
                
                // Show panels
                document.getElementById('statsPanel').classList.remove('hidden');
                document.getElementById('searchPanel').classList.remove('hidden');
                document.getElementById('tablePanel').classList.remove('hidden');
                document.getElementById('setupPanel').classList.add('hidden');
                
                // Enable buttons
                document.getElementById('refreshBtn').disabled = false;
                document.getElementById('addBtn').disabled = false;
                document.getElementById('kitsBtn').disabled = false;
            } else {
                status.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-red-500"></span>
                        <span class="font-medium text-red-800">Not Connected</span>
                    </div>
                    <p class="text-red-600 text-sm mt-1">Click Setup to configure</p>
                `;
                status.className = 'p-4 rounded-lg bg-red-50 border border-red-200';
                
                // Hide panels
                document.getElementById('statsPanel').classList.add('hidden');
                document.getElementById('searchPanel').classList.add('hidden');
                document.getElementById('tablePanel').classList.add('hidden');
                
                // Disable buttons
                document.getElementById('refreshBtn').disabled = true;
                document.getElementById('addBtn').disabled = true;
                document.getElementById('kitsBtn').disabled = true;
            }
        }

        async function loadParts() {
            if (!isConnected) return;
            
            try {
                console.log('Loading parts...');
                const response = await fetch(apiUrl + '?action=getParts');
                const data = await response.json();
                
                if (data.success) {
                    parts = data.data;
                    allParts = [...parts];
                    renderParts();
                    updateStats();
                    console.log('Parts loaded:', parts.length);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Error loading parts:', error);
                alert('Failed to load parts: ' + error.message);
            }
        }

        function renderParts() {
            const tbody = document.getElementById('partsTable');
            tbody.innerHTML = '';

            parts.forEach(part => {
                const status = getStockStatus(part);
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium">${part.name}</td>
                    <td class="px-4 py-3 text-center">
                        ${status === 'critical' ? 'üö®' : status === 'warning' ? '‚ö†Ô∏è' : '‚úÖ'} ${part.currentStock}
                    </td>
                    <td class="px-4 py-3 text-center">${part.minStock}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 rounded text-xs ${getStatusClass(status)}">${getStatusText(status)}</span>
                    </td>
                    <td class="px-4 py-3 text-right">$${part.price}</td>
                    <td class="px-4 py-3">${part.supplier}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="adjustStock(${part.id}, 1)" class="bg-green-500 text-white px-2 py-1 rounded text-xs mr-1">+1</button>
                        <button onclick="adjustStock(${part.id}, -1)" class="bg-red-500 text-white px-2 py-1 rounded text-xs mr-1">-1</button>
                        <button onclick="deletePart(${part.id})" class="bg-gray-500 text-white px-2 py-1 rounded text-xs">üóëÔ∏è</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });

            document.getElementById('noResults').classList.toggle('hidden', parts.length > 0);
        }

        function getStockStatus(part) {
            if (part.currentStock === 0 || part.currentStock <= part.minStock) return 'critical';
            if (part.currentStock <= part.minStock * 1.5) return 'warning';
            return 'normal';
        }

        function getStatusClass(status) {
            switch(status) {
                case 'critical': return 'bg-red-100 text-red-800';
                case 'warning': return 'bg-yellow-100 text-yellow-800';
                default: return 'bg-green-100 text-green-800';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'critical': return 'Critical';
                case 'warning': return 'Low';
                default: return 'Good';
            }
        }

        function updateStats() {
            const total = allParts.length;
            const critical = allParts.filter(part => getStockStatus(part) === 'critical').length;
            const totalValue = allParts.reduce((sum, part) => sum + (part.currentStock * part.price), 0);

            document.getElementById('totalCount').textContent = total;
            document.getElementById('criticalCount').textContent = critical;
            document.getElementById('totalValue').textContent = '$' + totalValue.toLocaleString();
            document.getElementById('kitsCount').textContent = kits.length;
        }

        function filterParts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            parts = allParts.filter(part => 
                part.name.toLowerCase().includes(searchTerm) ||
                part.supplier.toLowerCase().includes(searchTerm)
            );
            renderParts();
        }

        async function adjustStock(id, change) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'updateStock', id: id, change: change })
                });
                
                const data = await response.json();
                if (data.success) {
                    await loadParts();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                alert('Failed to update stock: ' + error.message);
            }
        }

        async function deletePart(id) {
            const part = allParts.find(p => p.id == id);
            if (!confirm(`Delete "${part.name}"?`)) return;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'deletePart', id: id })
                });
                
                const data = await response.json();
                if (data.success) {
                    await loadParts();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                alert('Failed to delete part: ' + error.message);
            }
        }

        function showAddForm() {
            document.getElementById('addForm').classList.remove('hidden');
        }

        function hideAddForm() {
            document.getElementById('addForm').classList.add('hidden');
            clearForm();
        }

        function clearForm() {
            ['partName', 'partStock', 'partMinStock', 'partPrice', 'partSupplier'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }

        async function addPart() {
            const name = document.getElementById('partName').value.trim();
            if (!name) {
                alert('Please enter a part name');
                return;
            }

            const newPart = {
                action: 'addPart',
                name: name,
                currentStock: parseInt(document.getElementById('partStock').value) || 0,
                minStock: parseInt(document.getElementById('partMinStock').value) || 0,
                price: parseFloat(document.getElementById('partPrice').value) || 0,
                supplier: document.getElementById('partSupplier').value.trim()
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newPart)
                });
                
                const data = await response.json();
                if (data.success) {
                    hideAddForm();
                    await loadParts();
                    alert('Part added successfully!');
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                alert('Failed to add part: ' + error.message);
            }
        }

        function showKitsPanel() {
            document.getElementById('kitsPanel').classList.remove('hidden');
            renderKits();
        }

        function hideKitsPanel() {
            document.getElementById('kitsPanel').classList.add('hidden');
        }

        function renderKits() {
            const kitsList = document.getElementById('kitsList');
            if (kits.length === 0) {
                kitsList.innerHTML = '<p class="text-gray-500 text-center py-4">No kits yet. Create your first kit!</p>';
            } else {
                kitsList.innerHTML = kits.map(kit => `
                    <div class="bg-gray-50 p-4 rounded border mb-2">
                        <h3 class="font-semibold">${kit.name}</h3>
                        <p class="text-sm text-gray-600">${kit.description}</p>
                    </div>
                `).join('');
            }
        }

        function createKit() {
            const name = prompt('Kit name:');
            if (!name) return;
            
            const description = prompt('Kit description:');
            
            const newKit = {
                id: Date.now(),
                name: name,
                description: description || '',
                parts: []
            };
            
            kits.push(newKit);
            localStorage.setItem('poolPartsKits', JSON.stringify(kits));
            renderKits();
            updateStats();
        }

        function copyCode() {
            const code = document.getElementById('codeBlock').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('üìã Code copied to clipboard!');
            });
        }

        // Initialize kits
        const savedKits = localStorage.getItem('poolPartsKits');
        if (savedKits) {
            kits = JSON.parse(savedKits);
        }

        console.log('Script loaded successfully');
    </script>
</body>
</html>